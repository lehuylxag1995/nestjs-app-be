enum PurcharsOrderStatus {
    DRAFT // Tạo chưa gửi nhà cung cấp
    PARTIALLY_RECEIVED // Shop nhận một phần còn một phần
    RECEIVED // Shop nhận đủ hàng từ nhà cung cấp
    CANCELED // Shop hủy đơn đặt hàng từ nhà cung cấp
}

//Đơn đặt hàng với nhà cung cấp
model PurcharsOrder {
    id                   String              @id @default(uuid())
    status               PurcharsOrderStatus @default(DRAFT) //Trạng thái đơn hàng
    supplierId           String // Nhà cung cấp
    createdById          String // Người tạo đơn
    orderDate            DateTime // Ngày đặt hàng
    expectedDeliveryDate DateTime // Ngày giao hàng dự kiến
    totalNotTax          Decimal             @default(0) @db.Decimal(13, 3) // Tổng giá trị chưa thuế
    totalWithTax         Decimal             @default(0) @db.Decimal(13, 3) // Tổng giá trị đã bao gồm thuế
    note                 String? // Ghi chú đơn đặt hàng với nhà cung cấp
    createdAt            DateTime            @default(now())
    updatedAt            DateTime            @updatedAt

    Supplier  Supplier @relation(fields: [supplierId], references: [id])
    CreatedBy User     @relation(fields: [createdById], references: [id])

    PurcharsOrderItems    PurcharsOrderItem[]
    InventoryTransactions InventoryTransaction[]

    @@index([supplierId, createdById])
    @@map("PurcharsOrders")
}

model PurcharsOrderItem {
    id                    String  @id @default(uuid())
    purcharsOrderId       String
    productId             String
    variantId             String
    orderQuantity         BigInt // Số lượng yêu cầu random
    totalReceivedQuantity BigInt  @default(0) // Số lượng thực nhận 
    unitCost              Decimal @default(0) @db.Decimal(13, 3) // Giá từ nhà cung cấp random (giá mua, giá vốn)
    taxRate               Decimal @default(0) @db.Decimal(5, 2) // Thuế bao nhiêu phần trăm random
    taxAmount             Decimal @default(0) @db.Decimal(13, 3) // Thuế thành tiền
    unitCostWithTax       Decimal @default(0) @db.Decimal(13, 3) // Giá sau thuế
    totalCostNotTax       Decimal @default(0) @db.Decimal(13, 3) // Thành tiền không thuế
    totalCostWithTax      Decimal @default(0) @db.Decimal(13, 3) // Thành tiền chịu thuế

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    PurcharOrder              PurcharsOrder              @relation(fields: [purcharsOrderId], references: [id])
    Product                   Product                    @relation(fields: [productId], references: [id])
    ProductVariant            ProductVariant             @relation(fields: [variantId], references: [id])
    PurchaseOrderItemReceipts PurchaseOrderItemReceipt[]

    @@map("PurchaseOrderItems")
}

//Bảng này dành riêng cho PurcharsOrder status = Partially_received.
//Để lưu tất cả lần nhận theo PurcharsOrderItem
model PurchaseOrderItemReceipt {
    id                   String                @id @default(uuid())
    purcharsOrderItemId  String // Thuộc chi tiết đơn nhập hàng nào ?
    receivedQuantity     BigInt // Số lượng nhận
    receivedById         String // Người nhận đơn
    receivedDate         DateTime              @default(now()) // Ngày nhận
    note                 String? // vd:Nhập bổ sung thêm theo đơn nhập hàng
    isProcessTransaction Boolean               @default(false) // Để kiểm tra InventoryTransaction tránh bị cộng dồn đơn cũ
    ReceivedBy           User                  @relation(fields: [receivedById], references: [id])
    PurcharsOrderItem    PurcharsOrderItem     @relation(fields: [purcharsOrderItemId], references: [id])
    InventoryTransaction InventoryTransaction?
}

// Tạo PurchaseOrder → status = DRAFT
// Gửi PO cho nhà cung cấp → status = SENT
// Nhận một phần hoặc toàn bộ hàng:
// Cập nhật receivedQuantity trong PurchaseOrderItem
// Tạo InventoryTransaction type = IMPORT
//      Nếu nhận đủ → status = RECEIVED
//      Nếu chưa đủ → status = PARTIALLY_RECEIVED

// hàm nhập hàng (PurcharsOrderItem + update tồn kho + tính averageCostPrice mới + update giá niêm yết) 

//Trường hợp số lượng nhập hàng orderQuantity === totalReceivedQuantity (status RECEIVED)
//Trường hợp số lượng nhập hàng orderQuantity > totalReceivedQuantity:
//  Áp dụng bảng PurchaseOrderItemReceipt để xác nhận đã nhận thêm cho đủ.
