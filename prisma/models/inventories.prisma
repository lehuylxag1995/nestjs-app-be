//CHÚ Ý: 1 dòng lưu trữ trong kho là áp dụng với 1 chi tiết sản phẩm. Không phải tất cả sản phẩm
model Inventory {
    id                String   @id @default(uuid())
    productId         String
    variantId         String   @unique // Kho lưu theo biến thể
    // Update lại mỗi khi import hàng
    quantityOnHand    BigInt // Số lượng trong kho thuộc sản phẩm
    quantityReserved  BigInt // Số lượng khách đặt (dành cho đơn hàng chưa giao,  tránh bán vượt tồn kho)
    //Dùng tránh bán vượt tồn kho, hiển thị cho khách biết thực tế, kết hợp với minStock để thông báo
    quantityAvaliable BigInt // Số lượng có thể xuất kho ( quantityOnHand - quantityReserved)
    // Update lại mỗi khi import hàng
    averageCostPrice  Decimal  @db.Decimal(13, 3) // Giá nhập bình quân gia quyền cho 1 sản phẩm
    // Không lấy từ InventoryTransaction trực tiếp mà tính từ số lượng tồn và giá vốn mới.
    totalCostValue    Decimal  @db.Decimal(13, 3) // Giá trị tồn kho cho 1 sản phẩm (averageCost × quantityOnHand)
    minStock          Int? // ngưỡng cảnh báo hết hàng
    maxStock          Int? // Tồn tối đa (tránh ứ hàng)
    note              String? //Ghi chú: kiểm kê, cảnh báo
    createdAt         DateTime @default(now())
    updatedAt         DateTime @updatedAt

    // Số lượng trong kho chỉ thuộc 1 biến thể
    Product        Product                @relation(fields: [productId], references: [id])
    ProductVariant ProductVariant         @relation(fields: [variantId], references: [id])
    Transactions   InventoryTransaction[]

    @@index([productId])
    @@map("Inventories")
}

enum TransactionType {
    IMPORT // Nhập kho () -> tăng số lượng trong kho

    // Xuất kho -> giảm số lượng trong kho
    //khi OrderStatus: SHIPPED
    EXPORT

    // Giữ hàng -> tăng quantityReserved
    //khi OrderStatus: CONFIRMED
    RESERVE

    // Thả hàng -> giảm quantityReserved
    //khi OrderStatus: CANCELLED -> với TransactionType đã là RESERVE
    RELEASE

    // Trả hàng khách trả lại -> trả lại số lượng trong kho
    //khi OrderStatus: CANCELLED -> với TransactionType đã là EXPORT
    //khi OrderStatus: RETURNED 
    RETURN

    ADJUSTMENT // Điều chỉnh kho (kiểm kê) -> tăng hoặc giảm
}

//Lưu mọi biến động kho — bao gồm bán, nhập, trả hàng, hủy... để quản lý kho
model InventoryTransaction {
    //Thông tin chung
    id               String          @id @default(uuid())
    type             TransactionType @default(ADJUSTMENT) // IMPORT, EXPORT, RETURN, ADJUSTMENT
    purcharsOrderId  String? //Có áp dụng theo đơn nhập ? 
    orderId          String? //Có áp dụng theo đơn bán ? 
    quantity         BigInt          @default(0) // số lượng + (nhập) hoặc - (xuất)
    //Bán hàng
    listedPrice      Decimal?        @default(0) @db.Decimal(13, 3) // Nếu type là export là giá bán (giá niêm yết bao gồm thuế)
    //Nhập hàng
    costPrice        Decimal?        @default(0) @db.Decimal(13, 3) // Nếu type là import là giá vốn chưa bao gồm thuế
    taxRate          Decimal?        @default(0) @db.Decimal(5, 3) // % Thuế
    taxAmount        Decimal?        @default(0) @db.Decimal(13, 3) // unitCost/costPrice * (taxRate/100) 
    costPriceWithTax Decimal?        @default(0) @db.Decimal(13, 3) // Giá sau thuế : costPrice + taxAmount
    totalCostNotTax  Decimal?        @default(0) @db.Decimal(13, 3) // costPrice * quantity
    totalCostWithTax Decimal?        @default(0) @db.Decimal(13, 3) // costPriceWithTax * quantity

    productId   String //Nhập/xuất sản phẩm gì ?
    variantId   String //Biến thể sản phẩm đó
    userId      String //Người chịu trách nhiệm nhập/xuất
    inventoryId String //Liên quan tới dữ liệu nào trong kho ?

    note      String? //bán hàng, hủy đơn, nhập theo lô A...
    createdAt DateTime @default(now())

    //Thông tin sản phẩm
    Product        Product        @relation(fields: [productId], references: [id])
    ProductVariant ProductVariant @relation(fields: [variantId], references: [id])
    //Thông tin người chịu trách nhiệm
    User           User           @relation(fields: [userId], references: [id])
    //Thông tin liên quan Import/Export
    PurcharsOrder  PurcharsOrder? @relation(fields: [purcharsOrderId], references: [id])
    Order          Order?         @relation(fields: [orderId], references: [id])
    //Thông tin liên quan kho
    Inventory      Inventory      @relation(fields: [inventoryId], references: [id])

    @@index([type, productId, variantId, userId, inventoryId])
    @@map("InventoryTransactions")
}
